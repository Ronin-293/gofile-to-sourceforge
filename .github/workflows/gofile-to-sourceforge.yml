name: Mirror Gofile to SourceForge

on:
  workflow_dispatch:
    inputs:
      gofile_url:
        description: "Gofile share link (can include /web/)"
        required: true

      sf_folder:
        description: "SourceForge folder name (e.g. Lunaris-AOSP)"
        required: true

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: |
          sudo apt update
          sudo apt install -y wget sshpass grep

      - name: Download ROM (Correct Gofile scrape → real link)
        run: |
          echo "Fetching Gofile page to extract real link..."

          # Step 1: Fetch the gofile.io/d/... page (this contains the REAL link)
          PAGE_HTML=$(curl -s "${{ github.event.inputs.gofile_url }}")

          # Step 2: Extract REAL storage URL (WITHOUT /web/)
          REAL_URL=$(echo "$PAGE_HTML" | grep -oP 'https://store[^"]+/download/[^"]+\.zip' | head -n 1)

          echo "Resolved real storage URL:"
          echo "$REAL_URL"

          if [ -z "$REAL_URL" ]; then
            echo "ERROR: Could not extract real Gofile download link!"
            echo "Debug: First 500 chars of page:"
            echo "$PAGE_HTML" | head -c 500
            exit 1
          fi

          echo "Downloading real file using wget..."

          wget \
            --header="User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)" \
            --header="Referer: https://gofile.io/" \
            --content-disposition \
            --tries=10 \
            --timeout=60 \
            "$REAL_URL"

          echo "Downloaded files:"
          ls -lh

          FILE_NAME=$(ls *.zip | head -n 1 || true)

          if [ -z "$FILE_NAME" ]; then
            echo "ERROR: No ZIP file downloaded!"
            exit 1
          fi

          # Safety check — must be > 1GB (real ROM)
          FILE_SIZE=$(stat -c%s "$FILE_NAME")
          echo "Downloaded size: $FILE_SIZE bytes"

          if [ "$FILE_SIZE" -lt 1073741824 ]; then
            echo "ERROR: File too small — likely fake download!"
            exit 1
          fi

          echo "Detected file: $FILE_NAME"
          echo "FILE_NAME=$FILE_NAME" >> $GITHUB_ENV

      - name: Upload to SourceForge (dynamic folder)
        run: |
          echo "Uploading $FILE_NAME to SourceForge folder: ${{ github.event.inputs.sf_folder }}"

          sshpass -p "${{ secrets.SF_PASSWORD }}" sftp -o StrictHostKeyChecking=no \
          ${{ secrets.SF_USER }}@frs.sourceforge.net <<EOF
          cd /home/frs/project/${{ secrets.SF_PROJECT }}/${{ github.event.inputs.sf_folder }}
          put $FILE_NAME
          bye
          EOF
