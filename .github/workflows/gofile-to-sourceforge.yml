name: Mirror Gofile to SourceForge

on:
  workflow_dispatch:
    inputs:
      gofile_url:
        description: "Direct Gofile download link"
        required: true

      sf_folder:
        description: "SourceForge folder name (e.g. Lunaris-AOSP, Bliss-AOSP, etc.)"
        required: true

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: |
          sudo apt update
          sudo apt install -y aria2 sshpass

      - name: Download ROM (preserve original filename)
        run: |
          echo "Downloading from Gofile using aria2..."

          # Convert /download/web/ link to real direct link automatically
          DIRECT_URL=$(echo "${{ github.event.inputs.gofile_url }}" | sed 's/\/download\/web\//\/download\//')
          echo "Using direct URL: $DIRECT_URL"

          aria2c \
            --max-connection-per-server=16 \
            --split=16 \
            --min-split-size=5M \
            --file-allocation=trunc \
            --retry-wait=10 \
            --retry=5 \
            --user-agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64)" \
            --referer="https://gofile.io/" \
            --auto-file-renaming=false \
            -o "$(basename "$DIRECT_URL")" \
            "$DIRECT_URL"

          echo "Downloaded files:"
          ls -lh

          # Capture exact filename
          FILE_NAME=$(ls *.zip | head -n 1 || true)

          if [ -z "$FILE_NAME" ]; then
            echo "ERROR: No ZIP file downloaded!"
            exit 1
          fi

          echo "Detected file: $FILE_NAME"
          echo "FILE_NAME=$FILE_NAME" >> $GITHUB_ENV

      - name: Upload to SourceForge (dynamic folder)
        run: |
          echo "Uploading $FILE_NAME to SourceForge folder: ${{ github.event.inputs.sf_folder }}"

          sshpass -p "${{ secrets.SF_PASSWORD }}" sftp -o StrictHostKeyChecking=no \
          ${{ secrets.SF_USER }}@frs.sourceforge.net <<EOF
          cd /home/frs/project/${{ secrets.SF_PROJECT }}/${{ github.event.inputs.sf_folder }}
          put $FILE_NAME
          bye
          EOF
