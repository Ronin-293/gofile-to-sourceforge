name: Mirror Google Drive to SourceForge

on:
  workflow_dispatch:
    inputs:
      gdrive_url:
        description: "Google Drive share link"
        required: true

      sf_folder:
        description: "SourceForge folder name (e.g. Lunaris-AOSP)"
        required: true

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: |
          sudo apt update
          sudo apt install -y python3-pip sshpass
          pip3 install gdown

      - name: Download ROM from Google Drive
        run: |
          echo "Downloading from Google Drive..."

          RAW_URL="${{ github.event.inputs.gdrive_url }}"
          echo "Raw input URL: $RAW_URL"

          # ---- Proper File ID extraction ----

          # Try /d/ style link first
          FILE_ID=$(echo "$RAW_URL" | sed -E 's#.*/d/([^/]+).*#\1#')

          # If still not extracted, try id= format
          if [ "$FILE_ID" = "$RAW_URL" ]; then
            FILE_ID=$(echo "$RAW_URL" | sed -E 's/.*id=([^&]+).*/\1/')
          fi

          echo "Final extracted File ID: $FILE_ID"

          if [ -z "$FILE_ID" ]; then
            echo "ERROR: Could not extract Google Drive File ID!"
            exit 1
          fi

          # ---- Download with confirmation bypass ----
          echo "Starting gdown download..."
          gdown "https://drive.google.com/uc?id=$FILE_ID&confirm=t" --fuzzy

          echo "Downloaded files:"
          ls -lh

          FILE_NAME=$(ls *.zip | head -n 1 || true)

          if [ -z "$FILE_NAME" ]; then
            echo "ERROR: No ZIP file downloaded!"
            exit 1
          fi

          FILE_SIZE=$(stat -c%s "$FILE_NAME")
          echo "Downloaded size: $FILE_SIZE bytes"

          if [ "$FILE_SIZE" -lt 1073741824 ]; then
            echo "ERROR: File too small â€” likely wrong download!"
            exit 1
          fi

          echo "Detected file: $FILE_NAME"
          echo "FILE_NAME=$FILE_NAME" >> $GITHUB_ENV

      - name: Upload to SourceForge
        run: |
          echo "Uploading ${{ env.FILE_NAME }} to folder: ${{ github.event.inputs.sf_folder }}"

          sshpass -p "${{ secrets.SF_PASSWORD }}" sftp -o StrictHostKeyChecking=no \
          ${{ secrets.SF_USER }}@frs.sourceforge.net <<EOF
          cd /home/frs/project/${{ secrets.SF_PROJECT }}/${{ github.event.inputs.sf_folder }}
          put "${{ env.FILE_NAME }}"
          bye
          EOF
